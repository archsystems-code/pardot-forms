<!-- Below Form -->
<script src="https://unpkg.com/dropbox/dist/Dropbox-sdk.min.js"></script>
<script src="http://www2.archsystems.com/l/67312/2018-01-18/bbf6h3/67312/171294/dropzone.js"></script>
<script src="http://www2.archsystems.com/l/67312/2018-01-19/bbffwf/67312/171344/progressbar.min.js"></script>
<script>
  var maxBlob = 8 * 1000 * 1000;
  function uploadFiles(e) {
    e.preventDefault();
    var ACCESS_TOKEN = "E2kOOrj3PAoAAAAAAAAV3iglJznk6_o8_PNYC16bHyIWLXCrPQxQXZLB-Nt7SfcJ";
    var dbx = new Dropbox({ accessToken: ACCESS_TOKEN });
    var bar = new ProgressBar.Line("#container", {
      strokeWidth: 4,
      easing: 'easeInOut',
      color: "#FFEA82",
      trailColor: "#eee",
      trailWidth: 1,
      svgStyle: { width: "100%", height: "100%" },
      text: {
        style: {
          color: '#999',
          position: 'absolute',
          right: '0',
          top: '30px',
          padding: 0,
          margin: 0,
          transform: null
        }
      },
      from: { color: "#FFEA82" },
      to: { color: "#ED6A5A" },
      step: (state, bar) => {
        bar.setText(Math.round(bar.value() * 100) + "%")
      }
    })
    var body = document.getElementsByTagName("body");
    var thankYou = document.createElement("P");
    var thankYouText = document.createTextNode("Thanks for submitting your photo - good luck!");
    thankYou.appendChild(thankYouText);
    body[0].appendChild(thankYou);
    var form = document.getElementsByTagName("form");
    form[0].style.display = "none";
    var myDropzone = Dropzone.forElement("#file-upload");
    var firstName = document.getElementById("67312_132962pi_67312_132962").value;
    var lastName = document.getElementById("67312_132964pi_67312_132964").value;
    console.log("Upload files: %0", myDropzone.files);
    var workItems = [];
    var workItemsSize = 0;
    myDropzone.files.forEach(function(file){
      if (file.size < maxBlob) {
        workItems.push({file: file, chunk: false, size: file.size});
        workItemsSize += file.size;
      } else {
        var offset = 0;
        while (offset < file.size) {
          var chunkSize = Math.min(maxBlob, file.size - offset);
          workItems.push({file: file, chunk: true, offset: offset, end: offset + chunkSize, size: chunkSize});
          workItemsSize += chunkSize;
          offset += chunkSize;
        }
        workItems[workItems.length-1].close = true;
      }
    });
    console.log("Workitems:", workItems);
    if (workItems.length === 1) {
      var file = workItems[0].file;
      console.log("Uploading file: " + file.name);
      dbx.filesUpload({ path: '/' + firstName + ' ' + lastName + '/' + file.name, contents: file })
        .then(function (response) {
          console.log(response);
          console.log("Completed uploading of file: " + file.name);
        })
        .catch(function (error) {
          console.error(error);
        });
    } else {
      var msg = (myDropzone.files.length === 1) ? "Uploading file: " + myDropzone.files[0].name : "Uploading files";
      var sessionId;
      var bytesUploaded = 0;
      var result = Promise.resolve();
      workItems.forEach(function(workItem) {
        var file = workItem.file;
        result = result.then(function() {
          if (!workItem.chunk) {
            console.log("Uploading file:", file.name);
            return dbx.filesUpload({ path: '/' + firstName + ' ' + lastName + '/' + file.name, contents: file })
              .then(function (response) {
                console.log(response);
                console.log("Completed uploading of file: " + file.name);
                bytesUploaded += workItem.size;
                console.log("progress", bytesUploaded/workItemsSize);
                bar.animate(bytesUploaded / workItemsSize, { duration: 1500 });
              })
              .catch(function (error) {
                console.error(error);
              });
          } else if (workItem.offset === 0) {
            console.log("Starting multipart upload of file:", file.name);
            var blob = file.slice(workItem.offset, workItem.end);
            return dbx.filesUploadSessionStart({close: false, contents: blob})
              .then(function(response) {
                sessionId = response.session_id;
                console.log("Complete multipart upload start, sessionId:", sessionId);
                bytesUploaded += workItem.size;
                console.log("progress", bytesUploaded/workItemsSize);
                bar.animate(bytesUploaded / workItemsSize, { duration: 1500 });
              })
          } else if (!workItem.close) {
            console.log("Putting chunk in multipart upload of file:", file.name);
            var cursor = { session_id: sessionId, offset: workItem.offset };
            var blob = file.slice(workItem.offset, workItem.end);
            return dbx.filesUploadSessionAppendV2({cursor: cursor, close: false, contents: blob})
              .then(function(response) {
                console.log("Complete multipart upload append");
                bytesUploaded += workItem.size;
                console.log("progress", bytesUploaded/workItemsSize);
                bar.animate(bytesUploaded / workItemsSize, { duration: 1500 });
              })
          } else {
            console.log("Completing multipart upload of file:", file.name);
            var cursor = { session_id: sessionId, offset: workItem.offset };
            var commit = { path: '/' + firstName + ' ' + lastName + '/' + file.name, mode: 'add', autorename: true, mute: false };
            var blob = file.slice(workItem.offset, workItem.end);
            return dbx.filesUploadSessionFinish({ cursor: cursor, commit: commit, contents: blob})
              .then(function(response) {
                console.log("Complete multipart upload finish");
                sessionId = null;
                bytesUploaded += workItem.size;
                console.log("progress", bytesUploaded/workItemsSize);
                bar.animate(bytesUploaded/workItemsSize, {duration: 1500});
              })
          }
        })
      })
      result.then(function() {
        console.log("Complete upload of workitem(s)");
        if (myDropzone.files.length === 1) {
          console.log("Completed uploading of file: " + myDropzone.files[0].name)
        } else {
          console.log("Completed uploading of multiple files")
        }
      })
      .catch(function(reason) {
        console.log("ERR:", reason)
      })
    }
    return false;
  };
  var head = document.head;
  var link = document.createElement("link");
  link.type="text/css";
  link.rel ="stylesheet";
  link.href = "http://www2.archsystems.com/l/67312/2018-01-18/bbf6xw/67312/171300/dropzone.css";
  head.appendChild(link);
  var form = document.getElementsByTagName("form");
  form[0].addEventListener("submit", uploadFiles, false);
  var newDropZoneItem = document.createElement("Div");
  newDropZoneItem.setAttribute("id", "file-upload");
  newDropZoneItem.setAttribute("class", "dropzone");
  var newProgressBarContainer = document.createElement("Div");
  newProgressBarContainer.setAttribute("id", "container")
  Dropzone.options.fileUpload = {
    url: "http://www2.archsystems.com/l/67312/2018-01-18/bbd5my",
    dictDefaultMessage: "Drop Photos or Videos Here"
  }
  form[0].insertBefore(newDropZoneItem, form[0].childNodes[24]);
  document.body.appendChild(newProgressBarContainer);
</script>